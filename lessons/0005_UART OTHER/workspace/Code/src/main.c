// STM32F4 UART
// ?????: vk.com/zz555 (11.08.2015)

// USART1 - TX=PA9(PB6), RX=PA10(PB7)
// USART2 - TX=PA2(PD5), RX=PA3(PD6)
// USART3 - TX=PB10(PD8), RX=PB11(PC11)
// UART4  - TX=PA0(PC10), RX=PA1(P11)
// UART5  - TX=PC12, RX=PD2
// USART6 - TX=PC7, RX=PC7

// ??? ???????? ?????? ??????? ? CooCox ? Viev/Repository/Pepipherals ????????? ?????? 2 ???????:
// M4 CMSIS core
// CMSIS BOOT

// ????? ???????? 2 ???????? ? ????????? ?????? ??? ????????? ??????? ?? ???????? ?????? 8 MHz
// #define PLL_M       8                        // 149 c??. cmsis_boot/system_stm32f4xx.c
// #define HSE_VALUE       ((uint32_t)8000000)               // 92 ???.  cmsis_boot/stm32f4xx.h

#include "stm32f4xx.h"

// ? Stm32f4Discovery ???? 4 ?????????? ?? ???????: PD12 (green), PD13 (orange), PD14 (red), PD15 (blue)
#define LED_ON            GPIOD->BSRRL = GPIO_BSRR_BS_15            // PD15 LED ON (????? ? ??????? 16 ???, ????? ????????)
#define LED_OFF           GPIOD->BSRRH = GPIO_BSRR_BS_15            // PD15 LED OFF (????? ? ??????? 16 ???, ????? ?????????)

uint32_t    tim_delay;
uint8_t      rx_status;
uint8_t      rx_data;
uint8_t      rx_bit;
uint8_t      rx_buf[64];

// ?????????? ?????????? ?????????? ???????, ?????????? ?????? 1 ms
void SysTick_Handler(void) {
   if (tim_delay != 0) tim_delay--;
}

// ??????? ????????? ???????? ? ????????????
void Delay_ms(uint32_t delay) {
   tim_delay = delay;
   while (tim_delay != 0) {
      if (rx_status == 1) return;
   }
}

// ?????????? ?? ?????? ?????? ?? USART
void USART1_IRQHandler(void) {
   if ((USART1->SR & USART_SR_RXNE) != 0) {                  // ???? ?????? ???-?? ?? USART
      rx_data = USART1->DR;                              // ????????? ?? ??? ?????? ? ??????????
      rx_buf[rx_bit]=rx_data;                            // ???????? ???????? ???? ? ?????
      if (rx_bit != 64) rx_bit++; else rx_bit=0;               // ?????????? ??????? ?????? ??????
      if (rx_data == 0x0D) rx_status=1;                     // ???? ?????? ????? ??????? <CR><LF> 0x0D,0x0A (13,10)
   }
}

// ??????? ?????????? ???? ? USART
void send_uart(uint_fast8_t data) {
   while (!(USART1->SR & USART_SR_TC));                     // ???? ???? ??? TC ? ???????? SR ?????? 1
   USART1->DR=data;                                    // ???????? ???? ????? UART
}

// ??????? ?????????? ?????? ? USART
void send_str(char * string) {
   uint8_t i=0;
   while (string[i]) {
      send_uart(string[i]);
      i++;
   }
   send_uart('\r');
   send_uart('\n');
}

// ????????????? stm
void stm_init(void) {
   SystemInit();
   SysTick_Config(168000);                                 // ?????? ?????????? ?? ????????? ???????? ??? ??????? 168 MHz - 1ms

   // ????????????? USART1
   RCC->APB2ENR  |= RCC_APB2ENR_USART1EN;
   RCC->AHB1ENR  |= RCC_AHB1ENR_GPIOBEN;
   RCC->AHB1ENR  |= RCC_AHB1ENR_GPIODEN;
   GPIOD->MODER  |= GPIO_MODER_MODER15_0;                     // LED (pin out)
   GPIOB->MODER  |= (GPIO_MODER_MODER6_1 | GPIO_MODER_MODER7_1);   // USART1 (TX=PB6, RX=PB7)
   GPIOB->AFR[0] |= 0x77000000;
   USART1->BRR    = 0x222E;                               // 9600
   USART1->CR1   |= USART_CR1_TE;                            // ????????? ??????????
   USART1->CR1   |= USART_CR1_RE;                            // ????????? ????????
   USART1->CR1   |= USART_CR1_UE;                            // ????????? USART
   USART1->CR1     |= USART_CR1_RXNEIE;                         // ????????? ?????????? ?? ?????? ??????
   NVIC_EnableIRQ (USART1_IRQn);                             // ????????? ?????????? ?? USART1
}

int main(void) {
   stm_init();                                        // ????????????? stm

   while (1) {
      LED_ON;
      Delay_ms(100);                                    // ???????? 0.1 ?
      LED_OFF;
      
      send_str("STM32F4");

      rx_status=0;
      rx_bit=0;
      Delay_ms(1000);                                    // ???????? 1 ?

      // ???????? ???????? ??????? ?? UART
      if (rx_status == 1) {
         if (rx_buf[0]=='5') {
            rx_status=0;
            rx_bit=0;
            rx_buf[0]=0;
            send_str("5 OK");                           // ????? "5 OK" ??? ?????? ????? "5"
            Delay_ms(1000);                              // ???????? 1 ?
         }
      }
   }
}
